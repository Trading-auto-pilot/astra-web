name: CI/CD Frontend AstraAI

on:
  push:
    branches:
      - PAPER
      - LIVE

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  GCP_HOST: ${{ secrets.GCP_HOST }}
  GCP_USER: ${{ secrets.GCP_USER }}
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  SERVICE_NAME: astraai-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: üö¶ Verifica modalit√† di deploy su LIVE
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          EVENT_NAME="${{ github.event_name }}"
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"

          echo "üîç Branch: $BRANCH_NAME, Evento: $EVENT_NAME, PR Source: $SOURCE_BRANCH, PR Target: $TARGET_BRANCH"

          if [[ "$BRANCH_NAME" == "LIVE" ]]; then
            if [[ "$EVENT_NAME" != "pull_request" ]]; then
              echo "‚ùå Deploy su LIVE permesso solo tramite Pull Request da PAPER"
              exit 1
            fi

            if [[ "$SOURCE_BRANCH" != "PAPER" || "$TARGET_BRANCH" != "LIVE" ]]; then
              echo "‚ùå Solo PR da PAPER a LIVE sono consentite"
              exit 1
            fi
          fi

          echo "‚úÖ Controllo superato, proseguo con il deploy..."

      - name: Leggi versione da release.json
        id: version
        run: |
          if [[ ! -f release.json ]]; then
            echo "‚ùå release.json non trovato!"
            exit 1
          fi
          VERSION=$(jq -r '.version' release.json)
          if [[ -z "$VERSION" || "$VERSION" == "null" ]]; then
            echo "‚ùå Campo .version non valido in release.json"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üè∑ Versione frontend: $VERSION"

      - name: Build and push frontend image (solo PAPER)
        if: ${{ github.ref_name == 'PAPER' }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          NAME="${{ env.SERVICE_NAME }}"
          echo "üîß Build & push $NAME:$VERSION"

          docker buildx build \
            --platform linux/amd64 \
            --push \
            --tag "$DOCKERHUB_USERNAME/$NAME:latest" \
            --tag "$DOCKERHUB_USERNAME/$NAME:$VERSION" \
            .

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy frontend su server
        run: |
          VERSION="${{ vars.ASTRAAI_VERSION }}"

          ssh -o StrictHostKeyChecking=no $GCP_USER@$GCP_HOST "ENV_NAME=${{ github.ref_name }} VERSION=$VERSION bash -s" << 'EOF'
            cd ~/deploy

            LOWER_ENV_NAME=$(echo "$ENV_NAME" | tr '[:upper:]' '[:lower:]')
            COMPOSE_FILE="docker-compose.${LOWER_ENV_NAME}.yml"
            LOWER_PROJECT_NAME="$LOWER_ENV_NAME"

            if [[ ! -f ".env" ]]; then
              echo "‚ùå .env non trovato in ~/deploy"
              exit 1
            fi

            # üîÅ aggiorna/aggiungi ASTRAAI_VERSION nel .env
            if grep -q '^ASTRAAI_VERSION=' .env; then
              sed -i "s/^ASTRAAI_VERSION=.*/ASTRAAI_VERSION=$VERSION/" .env
            else
              echo "ASTRAAI_VERSION=$VERSION" >> .env
            fi

            echo "üì• Pull immagine expovin/astraai-frontend:$VERSION"
            docker compose -f "$COMPOSE_FILE" --env-file .env -p "$LOWER_PROJECT_NAME" pull astraai-frontend

            echo "üöÄ Riavvio solo astraai-frontend"
            docker compose -f "$COMPOSE_FILE" --env-file .env -p "$LOWER_PROJECT_NAME" up -d --no-deps --force-recreate astraai-frontend

            echo "üßπ Pulizia immagini inutilizzate"
            docker image prune -a -f
          EOF

